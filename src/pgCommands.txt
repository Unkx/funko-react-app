-- ===================================
-- LOYALTY SYSTEM DATABASE MIGRATION
-- ===================================

-- 1. Dodaj kolumny do tabeli users (je≈õli jeszcze nie istniejƒÖ)
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS loyalty_points INT DEFAULT 0,
ADD COLUMN IF NOT EXISTS loyalty_level INT DEFAULT 1,
ADD COLUMN IF NOT EXISTS current_streak INT DEFAULT 0,
ADD COLUMN IF NOT EXISTS longest_streak INT DEFAULT 0,
ADD COLUMN IF NOT EXISTS last_streak_date DATE,
ADD COLUMN IF NOT EXISTS profile_frame VARCHAR(50) DEFAULT 'bronze',
ADD COLUMN IF NOT EXISTS active_title VARCHAR(100),
ADD COLUMN IF NOT EXISTS active_theme VARCHAR(50) DEFAULT 'default';

-- 2. Tabela poziom√≥w lojalno≈õci
CREATE TABLE IF NOT EXISTS loyalty_levels (
  id SERIAL PRIMARY KEY,
  level_number INT UNIQUE NOT NULL,
  level_name VARCHAR(50) NOT NULL,
  min_points INT NOT NULL,
  badge_emoji VARCHAR(10),
  frame_id VARCHAR(50),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Dodaj domy≈õlne poziomy
INSERT INTO loyalty_levels (level_number, level_name, min_points, badge_emoji, frame_id) 
VALUES 
  (1, 'Beginner', 0, 'üå±', 'bronze'),
  (2, 'Collector', 100, 'üì¶', 'silver'),
  (3, 'Expert', 500, '‚≠ê', 'gold'),
  (4, 'Master', 1000, 'üèÜ', 'platinum'),
  (5, 'Legend', 2500, 'üëë', 'diamond')
ON CONFLICT (level_number) DO NOTHING;

-- 3. Tabela osiƒÖgniƒôƒá (achievements)
CREATE TABLE IF NOT EXISTS achievements (
  id SERIAL PRIMARY KEY,
  achievement_id VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  category VARCHAR(50), -- 'collection', 'social', 'streak', 'special'
  emoji VARCHAR(10),
  points_reward INT DEFAULT 0,
  requirement_type VARCHAR(50), -- 'collection_count', 'friend_count', 'streak_days', etc.
  requirement_value INT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Dodaj przyk≈Çadowe osiƒÖgniƒôcia
INSERT INTO achievements (achievement_id, name, description, category, emoji, points_reward, requirement_type, requirement_value)
VALUES
  -- Collection achievements
  ('first_item', 'First Steps', 'Add your first item to collection', 'collection', 'üéØ', 50, 'collection_count', 1),
  ('collector_10', 'Starter Collector', 'Collect 10 Funko Pops', 'collection', 'üì¶', 100, 'collection_count', 10),
  ('collector_50', 'Serious Collector', 'Collect 50 Funko Pops', 'collection', 'üóÉÔ∏è', 250, 'collection_count', 50),
  ('collector_100', 'Pro Collector', 'Collect 100 Funko Pops', 'collection', 'üè™', 500, 'collection_count', 100),
  
  -- Social achievements
  ('first_friend', 'Making Friends', 'Add your first friend', 'social', 'üëã', 75, 'friend_count', 1),
  ('social_5', 'Social Butterfly', 'Have 5 friends', 'social', 'ü¶ã', 150, 'friend_count', 5),
  ('social_25', 'Popular User', 'Have 25 friends', 'social', '‚≠ê', 300, 'friend_count', 25),
  
  -- Streak achievements
  ('streak_7', 'Week Warrior', '7 day login streak', 'streak', 'üî•', 100, 'streak_days', 7),
  ('streak_30', 'Monthly Master', '30 day login streak', 'streak', 'üìÖ', 300, 'streak_days', 30),
  ('streak_100', 'Dedication', '100 day login streak', 'streak', 'üíé', 1000, 'streak_days', 100),
  
  -- Special achievements
  ('complete_profile', 'Complete Profile', 'Fill out all profile information', 'special', '‚úÖ', 100, 'profile_complete', 1),
  ('first_wishlist', 'Wishful Thinking', 'Add first item to wishlist', 'special', 'üí≠', 50, 'wishlist_count', 1)
ON CONFLICT (achievement_id) DO NOTHING;

-- 4. Tabela postƒôp√≥w u≈ºytkownik√≥w w osiƒÖgniƒôciach
CREATE TABLE IF NOT EXISTS user_achievements (
  id SERIAL PRIMARY KEY,
  user_id INT REFERENCES users(id) ON DELETE CASCADE,
  achievement_id VARCHAR(50) REFERENCES achievements(achievement_id),
  unlocked_at TIMESTAMP DEFAULT NOW(),
  is_new BOOLEAN DEFAULT TRUE, -- czy u≈ºytkownik widzia≈Ç powiadomienie
  UNIQUE(user_id, achievement_id)
);

-- 5. Tabela odblokowywanych nagr√≥d
CREATE TABLE IF NOT EXISTS user_rewards (
  id SERIAL PRIMARY KEY,
  user_id INT REFERENCES users(id) ON DELETE CASCADE,
  reward_type VARCHAR(50), -- 'frame', 'title', 'theme'
  reward_id VARCHAR(50),
  unlocked_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, reward_type, reward_id)
);

-- 6. Tabela historii punkt√≥w lojalno≈õci
CREATE TABLE IF NOT EXISTS loyalty_points_history (
  id SERIAL PRIMARY KEY,
  user_id INT REFERENCES users(id) ON DELETE CASCADE,
  points_change INT NOT NULL,
  reason VARCHAR(100),
  action_type VARCHAR(50),
  created_at TIMESTAMP DEFAULT NOW()
);

-- 7. Indeksy dla wydajno≈õci
CREATE INDEX IF NOT EXISTS idx_user_achievements_user ON user_achievements(user_id);
CREATE INDEX IF NOT EXISTS idx_user_rewards_user ON user_rewards(user_id);
CREATE INDEX IF NOT EXISTS idx_loyalty_history_user ON loyalty_points_history(user_id);
CREATE INDEX IF NOT EXISTS idx_users_loyalty_points ON users(loyalty_points DESC);

-- ===================================
-- FUNKCJE POMOCNICZE
-- ===================================

-- Funkcja do automatycznego przyznawania punkt√≥w
CREATE OR REPLACE FUNCTION award_loyalty_points(
  p_user_id INT,
  p_points INT,
  p_reason VARCHAR(100),
  p_action_type VARCHAR(50)
)
RETURNS void AS $$
BEGIN
  -- Dodaj punkty do u≈ºytkownika
  UPDATE users 
  SET loyalty_points = loyalty_points + p_points
  WHERE id = p_user_id;
  
  -- Zapisz historiƒô
  INSERT INTO loyalty_points_history (user_id, points_change, reason, action_type)
  VALUES (p_user_id, p_points, p_reason, p_action_type);
  
  -- Zaktualizuj poziom lojalno≈õci
  UPDATE users u
  SET loyalty_level = (
    SELECT MAX(level_number)
    FROM loyalty_levels
    WHERE min_points <= u.loyalty_points
  )
  WHERE id = p_user_id;
END;
$$ LANGUAGE plpgsql;

-- Funkcja do sprawdzania i odblokowywania osiƒÖgniƒôƒá
CREATE OR REPLACE FUNCTION check_and_unlock_achievements(p_user_id INT)
RETURNS TABLE(achievement_id VARCHAR, points INT) AS $$
BEGIN
  RETURN QUERY
  WITH user_stats AS (
    SELECT 
      p_user_id as user_id,
      (SELECT COUNT(*) FROM collection WHERE user_id = p_user_id) as collection_count,
      (SELECT COUNT(*) FROM wishlist WHERE user_id = p_user_id) as wishlist_count,
      (SELECT COUNT(*) FROM friendships WHERE (user_id = p_user_id OR friend_id = p_user_id) AND status = 'accepted') as friend_count,
      (SELECT current_streak FROM users WHERE id = p_user_id) as streak_days,
      (SELECT CASE WHEN name IS NOT NULL AND surname IS NOT NULL AND gender IS NOT NULL AND date_of_birth IS NOT NULL AND nationality IS NOT NULL THEN 1 ELSE 0 END FROM users WHERE id = p_user_id) as profile_complete
  ),
  eligible_achievements AS (
    SELECT a.achievement_id, a.points_reward
    FROM achievements a
    CROSS JOIN user_stats us
    WHERE NOT EXISTS (
      SELECT 1 FROM user_achievements ua 
      WHERE ua.user_id = p_user_id AND ua.achievement_id = a.achievement_id
    )
    AND (
      (a.requirement_type = 'collection_count' AND us.collection_count >= a.requirement_value) OR
      (a.requirement_type = 'wishlist_count' AND us.wishlist_count >= a.requirement_value) OR
      (a.requirement_type = 'friend_count' AND us.friend_count >= a.requirement_value) OR
      (a.requirement_type = 'streak_days' AND us.streak_days >= a.requirement_value) OR
      (a.requirement_type = 'profile_complete' AND us.profile_complete >= a.requirement_value)
    )
  )
  INSERT INTO user_achievements (user_id, achievement_id)
  SELECT p_user_id, ea.achievement_id
  FROM eligible_achievements ea
  RETURNING achievement_id, (SELECT points_reward FROM achievements WHERE achievements.achievement_id = user_achievements.achievement_id);
END;
$$ LANGUAGE plpgsql;

COMMENT ON TABLE loyalty_levels IS 'Definicje poziom√≥w lojalno≈õci';
COMMENT ON TABLE achievements IS 'Dostƒôpne osiƒÖgniƒôcia w systemie';
COMMENT ON TABLE user_achievements IS 'Odblokowane osiƒÖgniƒôcia u≈ºytkownik√≥w';
COMMENT ON TABLE user_rewards IS 'Odblokowane nagrody wizualne (ramki, tytu≈Çy, motywy)';
COMMENT ON TABLE loyalty_points_history IS 'Historia zmian punkt√≥w lojalno≈õci';