-- Run these SQL commands to update your database for the chat system

-- 1. Add is_read column to messages table (if it doesn't exist)
ALTER TABLE messages 
ADD COLUMN IF NOT EXISTS is_read BOOLEAN DEFAULT FALSE;

-- 2. Create index for faster message queries
CREATE INDEX IF NOT EXISTS idx_messages_conversation_created 
ON messages(conversation_id, created_at DESC);

-- 3. Create index for unread messages
CREATE INDEX IF NOT EXISTS idx_messages_read_status 
ON messages(conversation_id, sender_id, is_read) 
WHERE is_read = FALSE;

-- 4. Add index to friendships for faster lookups
CREATE INDEX IF NOT EXISTS idx_friendships_user_status 
ON friendships(user_id, status);

CREATE INDEX IF NOT EXISTS idx_friendships_friend_status 
ON friendships(friend_id, status);

-- 5. Add timestamp to conversations
ALTER TABLE conversations 
ADD COLUMN IF NOT EXISTS created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

-- 6. Update existing messages to be marked as read (optional - for existing data)
-- UPDATE messages SET is_read = TRUE WHERE created_at < NOW() - INTERVAL '1 day';

-- 7. Verify the structure
SELECT 
    table_name, 
    column_name, 
    data_type, 
    is_nullable
FROM information_schema.columns
WHERE table_name IN ('messages', 'conversations', 'friendships')
ORDER BY table_name, ordinal_position;